<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Streamer</title>
    <meta name="viewport" content="width=device-width">
</head>

<body>
    <main>
        <video controls></video>
    </main>
    <script>
        let constraintObj = {
            audio: true,
            video: {
                facingMode: "user",
                width: {
                    min: 640,
                    ideal: 1280,
                    max: 1920
                },
                height: {
                    min: 480,
                    ideal: 720,
                    max: 1080
                }
            }
        };
        //handle older browsers that might implement getUserMedia in some way
        if (navigator.mediaDevices === undefined) {
            navigator.mediaDevices = {};
            navigator.mediaDevices.getUserMedia = function(constraintObj) {
                let getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
                if (!getUserMedia) {
                    return Promise.reject(new Error('getUserMedia is not implemented in this browser'));
                }
                return new Promise(function(resolve, reject) {
                    getUserMedia.call(navigator, constraintObj, resolve, reject);
                });
            }
        } else {
            navigator.mediaDevices.enumerateDevices()
                .then(devices => {
                    devices.forEach(device => {
                        console.log(device.kind.toUpperCase(), device.label);
                        //, device.deviceId
                    })
                })
                .catch(err => {
                    console.log(err.name, err.message);
                })
        }
        navigator.mediaDevices.getUserMedia(constraintObj)
            .then(function(mediaStreamObj) {
                //connect the media stream to the first video element
                let video = document.querySelector('video');
                if ("srcObject" in video) {
                    console.log(mediaStreamObj);
                    console.log(window.URL.createObjectURL(mediaStreamObj));
                    video.srcObject = mediaStreamObj;
                    video.play();
                } else {
                    //old version
                    console.log(window.URL.createObjectURL(mediaStreamObj));
                    video.src = window.URL.createObjectURL(mediaStreamObj);
                    video.play();
                }

                video.addEventListener('canplay', () => {
                    let stream;
                    const fps = 10;
                    if (video.captureStream) {
                        stream = video.captureStream(fps);
                    } else if (video.mozCaptureStream) {
                        stream = video.mozCaptureStream(fps);
                    } else {
                        console.error('Stream capture is not supported');
                        stream = null;
                    }
                    const WS_URL = location.origin.replace(/^http/, 'ws');
                    const ws = new WebSocket(WS_URL);
                    ws.onopen = () => {
                        console.log(`Conectado com ${WS_URL}`);
                        console.log(stream);
                        ws.send(JSON.stringify(stream));
                    }
                });
            })
            .catch(function(err) {
                console.log(err.name, err.message);
            });

        /*********************************
        getUserMedia returns a Promise
        resolve - returns a MediaStream Object
        reject returns one of the following errors
        AbortError - generic unknown cause
        NotAllowedError (SecurityError) - user rejected permissions
        NotFoundError - missing media track
        NotReadableError - user permissions given but hardware/OS error
        OverconstrainedError - constraint video settings preventing
        TypeError - audio: false, video: false
        *********************************/
    </script>
</body>

</html>