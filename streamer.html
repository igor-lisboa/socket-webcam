<html>

<head>
    <title>Streamer</title>
</head>

<body>
    <video autoplay></video>
    <script>
        // obtem elemento video
        const video = document.querySelector('video');
        const mediaConfig = {
            video: {
                width: 200,
                height: 200
            }
        };
        // pede acesso para acessar webcam
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia(mediaConfig).then((stream) => {
                video.srcObject = stream;
                video.play();
            });
        } else if (navigator.getUserMedia) { // Padrao
            navigator.getUserMedia(mediaConfig).then((stream) => {
                video.srcObject = stream;
                video.play();
            });
        } else if (navigator.webkitGetUserMedia) { // WebKit-prefixado
            navigator.webkitGetUserMedia(mediaConfig).then((stream) => {
                video.srcObject = stream;
                video.play();
            });
        } else if (navigator.mozGetUserMedia) { // Mozilla-prefixado
            navigator.mozGetUserMedia(mediaConfig).then((stream) => {
                video.srcObject = stream;
                video.play();
            });
        }

        // retorna um frame codificado em base64
        const getFrame = () => {
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            const data = canvas.toDataURL('image/jpeg');
            return data;
        }
        const WS_URL = location.origin.replace(/^http/, 'ws');
        const FPS = 15;
        const ws = new WebSocket(WS_URL);
        ws.onopen = () => {
            console.log(`Connected to ${WS_URL}`);
            setInterval(() => {
                ws.send(getFrame());
            }, 1000 / FPS);
        }
    </script>
</body>

</html>